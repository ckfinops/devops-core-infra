
#!/bin/bash
set -e # Exit immediately if a command exits with a non-zero status.

# Add hostname to /etc/hosts
echo "127.0.0.1 $(hostname)" >> /etc/hosts

# Setup Hostname 
hostnamectl set-hostname "dev.cloudcostconsole.com"

# Configure Hostname unto hosts file 
echo "`hostname -I | awk '{ print $1}'` `hostname`" >> /etc/hosts 

# Install AWS CLI (Note: AL2023 uses dnf, yum is a symlink to it)
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# Install python 3.11
sudo dnf install -y python3.11
python3.11 --version 

# Create user and set password (replace 'myuser' and 'password' with your desired values)
sudo useradd -m -s /bin/bash c3cloudcostconsole
echo 'c3cloudcostconsole:c3cloudcostconsole' | sudo chpasswd

# Add user to wheel group for sudo access (assumes 'c3cloudcostconsole' exists)
usermod -aG wheel c3cloudcostconsole

# Install Python 3 and pip (if not already installed)
sudo dnf install -y python3 python3-pip

# Apache httpd installation
sudo dnf update -y
sudo dnf install -y httpd.x86_64
sudo systemctl start httpd

# Download artifact from s3 
aws s3 cp s3:///devsecops/c3finops.tar.gz /opt/

# Unzip the artifact 
tar xvzf /opt/c3finops.tar.gz

# Move the files to DocumentRoot 
mv /opt/c3finops /var/www/html/

# Enable the webserver 
systemctl enable httpd

# Start the webserver
systemctl start httpd
